<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hyper Availability Profile (HAP)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0ea5e9; --primary-light: #f0f9ff; --primary-dark: #0369a1;
            --bg: #f8fafc; --card: #ffffff; --text: #0f172a; --muted: #64748b;
            --border-color: #e2e8f0; --input-bg: #f1f5f9;
            --radius: 12px; --shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        body.dark {
            --primary: #38bdf8; --primary-light: #1e293b; --primary-dark: #7dd3fc;
            --bg: #020617; --card: #0f172a; --text: #e2e8f0; --muted: #94a3b8;
            --border-color: #334155; --input-bg: #1e293b;
        }

        html { font-size: 16px; }
        
        body {
            margin: 0; padding: 20px 0 100px 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            background: var(--bg); color: var(--text);
            -webkit-font-smoothing: antialiased;
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- Navigation Header (Bottom Bar) --- */
        header {
            padding: 10px 14px; display: flex; gap: 12px; align-items: center; justify-content: center;
            background: var(--card); box-shadow: 0 -4px 12px rgba(0,0,0,0.05);
            position: fixed; bottom: 0; left: 0; right: 0;
            z-index: 100; border-top: 1px solid var(--border-color);
        }
        nav { display: flex; gap: 8px; align-items: center; width: 100%; max-width: 400px; justify-content: space-around; }
        .nav-btn {
            background: transparent; border: none; padding: 8px 10px; border-radius: 8px;
            cursor: pointer; color: var(--muted); font-weight: 500; font-size: 0.9rem;
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            transition: all 0.2s ease;
        }
        .nav-btn.active { background: var(--primary-light); color: var(--primary-dark); }
        .nav-btn:hover { color: var(--primary-dark); }
        .nav-btn svg { width: 24px; height: 24px; }

        /* --- Core Layout & Components --- */
        .container { max-width: 700px; margin: 0 auto; padding: 0 14px; }
        .page { display: none; }
        .card { background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); padding: 20px; margin-bottom: 20px; }
        
        h1 { font-size: 2rem; font-weight: 700; margin: 0 0 8px 0; text-align: center; }
        h2 { font-size: 1.5rem; font-weight: 600; margin: 0 0 16px 0; padding-bottom: 12px; border-bottom: 1px solid var(--border-color); }
        p { color: var(--muted); line-height: 1.6; margin: 4px 0; }
        label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--muted); }

        input, select, button { font-size: 1rem; font-family: inherit; }
        input, select {
            width: 100%; box-sizing: border-box; padding: 12px; border-radius: 8px;
            border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text);
        }
        input:focus, select:focus { outline: 2px solid var(--primary); border-color: var(--primary); }

        .btn {
            background: var(--primary); color: white; border: none; padding: 12px 18px;
            border-radius: 8px; cursor: pointer; font-weight: 600; transition: background-color 0.2s;
            width: 100%; text-align: center; display: block;
        }
        .btn:hover { opacity: 0.9; }
        .btn.secondary { background: var(--primary-light); color: var(--primary-dark); }
        .form-group { margin-bottom: 20px; }

        /* --- Page Specific Styles --- */
        /* Login Page */
        #loginPage .card { margin-top: 40px; }
        .auth-tabs { display: flex; margin-bottom: 25px; border-radius: 10px; background: var(--input-bg); padding: 5px; }
        .tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; border-radius: 8px; font-weight: 500; transition: background-color 0.3s ease; }
        .tab.active { background-color: var(--primary); color: #fff; }
        #error-message { color: #ef4444; text-align: center; min-height: 24px; font-weight: bold; margin-top: 15px; }
        
        /* Profile Page */
        .profile-header { text-align: center; margin-bottom: 30px; }
        .profile-emoji { font-size: 6rem; line-height: 1; margin: 16px 0; }
        .profile-name { font-size: 2.25rem; font-weight: 700; color: var(--text); margin: 0; }
        .profile-message { font-size: 1.2rem; color: var(--muted); min-height: 28px; }
        .profile-timer { font-size: 2.5rem; color: var(--primary); font-weight: 700; margin-top: 24px; min-height: 40px; }
        .profile-links { display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; margin-top: 30px; }
        .custom-link {
            display: inline-flex; align-items: center; gap: 8px; background: var(--primary-light);
            padding: 10px 15px; border-radius: 8px; text-decoration: none; color: var(--primary-dark);
            font-weight: 500; transition: all 0.2s ease;
        }
        .custom-link:hover { background-color: var(--primary); color: #fff; transform: translateY(-2px); }
        .custom-link svg { width: 18px; height: 18px; }

        /* Settings Page */
        .link-group { display: grid; grid-template-columns: 1fr 2fr; gap: 10px; margin-bottom: 15px; align-items: center; }
        @media (max-width: 500px) { .link-group { grid-template-columns: 1fr; } }

        /* --- Utilities --- */
        .hidden { display: none !important; }
        #toast {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            background: #0f172a; color: white; padding: 12px 20px; border-radius: 8px;
            z-index: 3000; visibility: hidden; opacity: 0; transition: all 0.4s ease;
            text-align: center; box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
        #toast.show { visibility: visible; opacity: 1; }
    </style>
</head>
<body>

    <header id="mainHeader" class="hidden">
        <nav>
            <button class="nav-btn" data-page="profilePage">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.5a5.5 5.5 0 0 1 3.096 10.047 9.005 9.005 0 0 1 5.9 8.181.75.75 0 0 1-1.498.07 7.502 7.502 0 0 0-15 0 .75.75 0 0 1-1.498-.07A9.005 9.005 0 0 1 9 12.55a5.5 5.5 0 0 1 3-10.05ZM12 4a4 4 0 1 0 0 8 4 4 0 0 0 0-8Z"></path></svg>
                <span>Profile</span>
            </button>
            <button class="nav-btn" data-page="settingsPage">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M11.64 3.023a.75.75 0 0 1 .72 0l1.517.65a.75.75 0 0 0 .841-.252l1.11-1.48A.75.75 0 0 1 17 2.25a.75.75 0 0 1 .633.368l1.11 1.48a.75.75 0 0 0 .84.253l1.518-.65a.75.75 0 0 1 .72 0l1.016.436a.75.75 0 0 1 .45 1.033l-.74 1.385a.75.75 0 0 0 .14.925l1.28.96a.75.75 0 0 1 0 1.302l-1.28.96a.75.75 0 0 0-.14.925l.74 1.385a.75.75 0 0 1-.45 1.033l-1.017.436a.75.75 0 0 1-.72 0l-1.517-.65a.75.75 0 0 0-.84.252l-1.11 1.48A.75.75 0 0 1 17 21.75a.75.75 0 0 1-.633-.368l-1.11-1.48a.75.75 0 0 0-.84-.253l-1.518.65a.75.75 0 0 1-.72 0l-1.016-.436a.75.75 0 0 1-.45-1.033l.74-1.385a.75.75 0 0 0-.14-.925l-1.28-.96a.75.75 0 0 1 0-1.302l1.28-.96a.75.75 0 0 0 .14-.925l-.74-1.385a.75.75 0 0 1 .45-1.033l1.017-.436ZM12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z"></path></svg>
                <span>Settings</span>
            </button>
        </nav>
    </header>

    <div class="container">

        <!-- Login/Signup Page -->
        <div id="loginPage" class="page">
            <div class="card">
                <h1>Hyper Availability</h1>
                <p style="text-align: center; margin-bottom: 24px;">Your real-time public status page.</p>
                <div class="auth-tabs">
                    <div class="tab active" data-tab="login">Login</div>
                    <div class="tab" data-tab="signup">Sign Up</div>
                </div>
                
                <form id="login-form">
                    <div class="form-group"><input type="email" id="login-email" placeholder="Email" required></div>
                    <div class="form-group"><input type="password" id="login-password" placeholder="Password" required></div>
                    <button type="submit" class="btn">Login</button>
                </form>
                
                <form id="signup-form" class="hidden">
                    <div class="form-group"><input type="text" id="signup-name" placeholder="Display Name" required></div>
                    <div class="form-group"><input type="email" id="signup-email" placeholder="Email" required></div>
                    <div class="form-group"><input type="password" id="signup-password" placeholder="Password" required></div>
                    <button type="submit" class="btn">Create Account</button>
                </form>
                <p id="error-message"></p>
            </div>
        </div>

        <!-- Public Profile & User's Main Profile Page -->
        <div id="profilePage" class="page">
            <div class="card profile-header">
                <div class="profile-emoji" id="profile-emoji">‚ùì</div>
                <h1 class="profile-name" id="profile-name">Loading...</h1>
                <p class="profile-message" id="profile-message">Fetching status...</p>
                <div class="profile-timer" id="profile-timer"></div>
            </div>
            <div class="card">
                <h2>Links</h2>
                <div class="profile-links" id="profile-links"><p class="muted">No links provided.</p></div>
            </div>
        </div>

        <!-- Settings Page -->
        <div id="settingsPage" class="page">
            <div class="card">
                <h2>Profile Settings</h2>
                <div class="form-group">
                    <label for="display-name">Display Name</label>
                    <input type="text" id="display-name">
                </div>
                <div class="form-group">
                    <label for="themeSelect">Theme</label>
                    <select id="themeSelect">
                        <option value="light">Light</option>
                        <option value="dark">Dark</option>
                    </select>
                </div>
            </div>
            <div class="card">
                <h2>Update Status</h2>
                <div class="form-group">
                    <label for="status-emoji">Current Status</label>
                    <select id="status-emoji">
                        <option value="üü¢">üü¢ Available</option>
                        <option value="üß†">üß† Deep Work</option>
                        <option value="üöó">üöó Commuting</option>
                        <option value="‚òï">‚òï On a Break</option>
                        <option value="üî¥">üî¥ Do Not Disturb</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="status-message">Message</label>
                    <input type="text" id="status-message" placeholder="e.g., Drafting 2026 Strategy">
                </div>
                <div class="form-group">
                    <label for="status-duration">Duration (minutes)</label>
                    <input type="number" id="status-duration" placeholder="e.g., 180 (0 for none)">
                </div>
            </div>
            <div class="card">
                <h2>Custom Links</h2>
                <div id="custom-links-container"></div>
            </div>
            <div class="card">
                <button id="save-settings-btn" class="btn">Save & Update Status</button>
                <button id="logout-btn" class="btn secondary" style="margin-top: 12px;">Logout</button>
            </div>
        </div>
    </div>
    
    <div id="toast"></div>

    <script>
        'use strict';
        const DATABASE_URL = "https://happp-96438-default-rtdb.firebaseio.com/";
        let countdownInterval;

        const App = {
            pages: ['loginPage', 'profilePage', 'settingsPage'],
            elements: {},
            currentUser: null,
            svg: {
                link: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12.25 8.25a.75.75 0 0 0-1.5 0v2.5h-2.5a.75.75 0 0 0 0 1.5h2.5v2.5a.75.75 0 0 0 1.5 0v-2.5h2.5a.75.75 0 0 0 0-1.5h-2.5v-2.5Z"></path><path fill-rule="evenodd" d="M8.25 3a.75.75 0 0 0-.75.75v1.64c0 .412.338.75.75.75h1.5A.75.75 0 0 0 10.5 5.4V3.75A.75.75 0 0 0 9.75 3h-1.5Zm-2.854 2.895a.75.75 0 0 0-1.06 1.06l4.242 4.243a.75.75 0 0 0 1.06-1.06L5.396 5.895ZM14.25 3a.75.75 0 0 0-.75.75v1.64c0 .412.338.75.75.75h1.5a.75.75 0 0 0 .75-.75V3.75a.75.75 0 0 0-.75-.75h-1.5Zm3.308 3.55a.75.75 0 0 0-1.06-1.06l-4.243 4.242a.75.75 0 1 0 1.06 1.06l4.243-4.242ZM18 9.75a.75.75 0 0 1 .75.75v1.5a.75.75 0 0 1-1.5 0v-1.5a.75.75 0 0 1 .75-.75Zm-5.308 4.955a.75.75 0 0 0-1.06 1.06l4.242 4.243a.75.75 0 0 0 1.06-1.06l-4.242-4.243ZM6 9.75a.75.75 0 0 1 .75.75v1.5a.75.75 0 0 1-1.5 0v-1.5A.75.75 0 0 1 6 9.75ZM8.25 15a.75.75 0 0 0-.75.75v1.64c0 .412.338.75.75.75h1.5a.75.75 0 0 0 .75-.75v-1.64a.75.75 0 0 0-.75-.75h-1.5Zm6 0a.75.75 0 0 0-.75.75v1.64c0 .412.338.75.75.75h1.5a.75.75 0 0 0 .75-.75v-1.64a.75.75 0 0 0-.75-.75h-1.5ZM2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12Z" clip-rule="evenodd"></path></svg>`
            }
        };
        
        // --- Utilities ---
        function emailToId(email) { return btoa(email.toLowerCase()).replace(/=/g, ''); }
        function showToast(message) {
            const toast = App.elements.toast;
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // --- Navigation & Page Handling ---
        function showPage(pageId) {
            App.pages.forEach(pId => App.elements[pId].classList.add('hidden'));
            App.elements[pageId].classList.remove('hidden');

            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.page === pageId);
            });
            window.scrollTo(0, 0);
        }
        
        function applyTheme(theme) {
            document.body.className = theme === 'dark' ? 'dark' : '';
            App.elements.themeSelect.value = theme;
        }

        // --- Core Application Logic ---
        function handlePageLoad() {
            // Cache all elements
            App.pages.forEach(pId => App.elements[pId] = document.getElementById(pId));
            App.elements.mainHeader = document.getElementById('mainHeader');
            App.elements.themeSelect = document.getElementById('themeSelect');
            App.elements.toast = document.getElementById('toast');
            
            // Handle URL params for public profiles
            const params = new URLSearchParams(window.location.search);
            const userIdFromUrl = params.get('user');

            if (userIdFromUrl) {
                App.elements.mainHeader.classList.add('hidden');
                showPage('profilePage');
                displayPublicProfile(userIdFromUrl);
            } else {
                const user = JSON.parse(sessionStorage.getItem('hapUser'));
                if (user) {
                    App.currentUser = user;
                    App.elements.mainHeader.classList.remove('hidden');
                    setupUserSession();
                } else {
                    App.elements.mainHeader.classList.add('hidden');
                    showPage('loginPage');
                }
            }
            addEventListeners();
        }

        async function setupUserSession() {
            // Fetch latest user data
            const response = await fetch(`${DATABASE_URL}/users/${App.currentUser.userId}.json`);
            const data = await response.json() || {};
            applyTheme(data.theme || 'light');
            showPage('profilePage');
            renderProfile(data);
            populateSettings(data);
        }

        // --- Data Rendering ---
        function renderProfile(data) {
            document.getElementById('profile-name').textContent = data.displayName || 'Unnamed User';
            document.getElementById('profile-emoji').textContent = data.status || '‚ùì';
            document.getElementById('profile-message').textContent = data.message || 'No message set.';
            updateTimer(data.endTime, document.getElementById('profile-timer'));
            renderCustomLinks(data.links, document.getElementById('profile-links'));
        }

        function populateSettings(data) {
            document.getElementById('display-name').value = data.displayName || App.currentUser.displayName;
            document.getElementById('themeSelect').value = data.theme || 'light';
            document.getElementById('status-emoji').value = data.status || 'üü¢';
            document.getElementById('status-message').value = data.message || '';
            const duration = data.endTime ? (new Date(data.endTime).getTime() - Date.now()) / 60000 : 0;
            document.getElementById('status-duration').value = duration > 0 ? Math.round(duration) : '';
            
            const linksContainer = document.getElementById('custom-links-container');
            linksContainer.innerHTML = '';
            for (let i = 0; i < 5; i++) {
                const link = data.links ? data.links[i] : null;
                linksContainer.innerHTML += `
                    <div class="link-group">
                        <input type="text" id="link-label-${i}" placeholder="Label ${i + 1}" value="${link ? link.label : ''}">
                        <input type="url" id="link-url-${i}" placeholder="https://..." value="${link ? link.url : ''}">
                    </div>`;
            }
        }
        
        function renderCustomLinks(links, container) {
            container.innerHTML = '';
            if (!links || links.length === 0) {
                container.innerHTML = '<p class="muted">No links provided.</p>';
                return;
            }
            links.forEach(link => {
                container.innerHTML += `
                    <a href="${link.url}" target="_blank" class="custom-link">
                        ${App.svg.link} <span>${link.label}</span>
                    </a>`;
            });
        }

        function displayPublicProfile(userId) {
            const fetchAndUpdate = () => {
                fetch(`${DATABASE_URL}/users/${userId}.json`)
                    .then(res => res.json())
                    .then(data => {
                        if (data) renderProfile(data);
                        else document.getElementById('profile-name').textContent = 'User Not Found';
                    });
            };
            fetchAndUpdate();
            setInterval(fetchAndUpdate, 15000);
        }
        
        function updateTimer(endTimeString, timerEl) {
            if (countdownInterval) clearInterval(countdownInterval);
            if (!endTimeString) { timerEl.textContent = ''; return; }
            const endTime = new Date(endTimeString).getTime();
            countdownInterval = setInterval(() => {
                const distance = endTime - Date.now();
                if (distance < 0) {
                    clearInterval(countdownInterval);
                    timerEl.textContent = "Time's up!";
                    return;
                }
                const h = Math.floor(distance / 36e5);
                const m = Math.floor((distance % 36e5) / 6e4);
                const s = Math.floor((distance % 6e4) / 1000);
                timerEl.textContent = h > 0 ? `${h}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}` : `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
            }, 1000);
        }
        
        // --- Event Listeners ---
        function addEventListeners() {
            document.querySelector('.auth-tabs').addEventListener('click', e => {
                if (e.target.classList.contains('tab')) {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    e.target.classList.add('active');
                    const isLogin = e.target.dataset.tab === 'login';
                    document.getElementById('login-form').classList.toggle('hidden', !isLogin);
                    document.getElementById('signup-form').classList.toggle('hidden', isLogin);
                }
            });
            
            App.elements.mainHeader.addEventListener('click', e => {
                const navBtn = e.target.closest('.nav-btn');
                if (navBtn) showPage(navBtn.dataset.page);
            });

            document.getElementById('signup-form').addEventListener('submit', handleSignup);
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            document.getElementById('save-settings-btn').addEventListener('click', handleSaveSettings);
        }
        
        // --- Event Handlers ---
        async function handleSignup(e) {
            e.preventDefault();
            const email = document.getElementById('signup-email').value.trim();
            const password = document.getElementById('signup-password').value;
            const displayName = document.getElementById('signup-name').value.trim();
            const errorMessage = document.getElementById('error-message');
            
            if (!email || !password || !displayName) {
                errorMessage.textContent = 'All fields are required.'; return;
            }

            const userId = emailToId(email);
            const response = await fetch(`${DATABASE_URL}/logins/${userId}.json`);
            if (await response.json()) {
                errorMessage.textContent = 'An account with this email already exists.'; return;
            }

            await fetch(`${DATABASE_URL}/logins/${userId}.json`, { method: 'PUT', body: JSON.stringify({ email, password, displayName }) });
            
            App.currentUser = { email, displayName, userId };
            sessionStorage.setItem('hapUser', JSON.stringify(App.currentUser));
            App.elements.mainHeader.classList.remove('hidden');
            setupUserSession();
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;
            const errorMessage = document.getElementById('error-message');
            if (!email || !password) {
                errorMessage.textContent = 'Email and password cannot be empty.'; return;
            }

            const userId = emailToId(email);
            const response = await fetch(`${DATABASE_URL}/logins/${userId}.json`);
            const data = await response.json();

            if (data && data.password === password) {
                App.currentUser = { email, displayName: data.displayName, userId };
                sessionStorage.setItem('hapUser', JSON.stringify(App.currentUser));
                App.elements.mainHeader.classList.remove('hidden');
                setupUserSession();
            } else {
                errorMessage.textContent = 'Invalid email or password.';
            }
        }
        
        function handleLogout() {
            sessionStorage.removeItem('hapUser');
            window.location.href = window.location.origin + window.location.pathname;
        }
        
        async function handleSaveSettings() {
            if (!App.currentUser) return;
            
            const customLinks = [];
            for (let i = 0; i < 5; i++) {
                const label = document.getElementById(`link-label-${i}`).value.trim();
                const url = document.getElementById(`link-url-${i}`).value.trim();
                if (label && url) customLinks.push({ label, url });
            }

            const duration = parseInt(document.getElementById('status-duration').value, 10);
            
            const dataToSave = {
                displayName: document.getElementById('display-name').value.trim(),
                theme: document.getElementById('themeSelect').value,
                status: document.getElementById('status-emoji').value,
                message: document.getElementById('status-message').value,
                updatedAt: new Date().toISOString(),
                links: customLinks,
                endTime: duration > 0 ? new Date(Date.now() + duration * 60 * 1000).toISOString() : null
            };
            
            await fetch(`${DATABASE_URL}/users/${App.currentUser.userId}.json`, { method: 'PUT', body: JSON.stringify(dataToSave) });
            applyTheme(dataToSave.theme);
            showToast('Settings Saved & Status Updated!');
            showPage('profilePage');
            renderProfile(dataToSave);
        }
        
        document.addEventListener('DOMContentLoaded', handlePageLoad);
    </script>
</body>
</html>

