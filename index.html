<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Q Solve â€” Direct API Version</title>

<style>
Â  :root {
Â  Â  --primary: #0ea5e9; --primary-light: #f0f9ff; --primary-dark: #0369a1;
Â  Â  --bg: #f0f9ff; --card: #ffffff; --text: #082f49; --muted: #64748b;
Â  Â  --success: #22c55e; --danger: #ef4444; --warning: #f97316;
Â  Â  --radius: 12px; --shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
Â  }
Â  body.dark {
Â  Â  --primary: #38bdf8; --primary-light: #0c4a6e; --primary-dark: #7dd3fc;
Â  Â  --bg: #020617; --card: #0f172a; --text: #e2e8f0; --muted: #94a3b8;
Â  }
Â  html { font-size: 16px; }
Â  body {
Â  Â  margin:0; padding:0 0 90px 0;
Â  Â  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
Â  Â  background: var(--bg); color:var(--text); -webkit-font-smoothing:antialiased;
Â  Â  transition: background-color 0.3s, color 0.3s;
Â  }
Â  header {
Â  Â  padding: 10px 14px; display:flex; gap:12px; align-items:center; justify-content:space-between;
Â  Â  background:var(--card); box-shadow: 0 -4px 12px rgba(0,0,0,0.05);
Â  Â  position: fixed; bottom: 0; left: 0; right: 0;
Â  Â  z-index: 50; border-top: 1px solid rgba(0,0,0,0.05);
Â  }
Â  .brand { display:flex; align-items:center; gap:10px; min-width: 0; flex-grow: 1; flex-shrink: 1; overflow: hidden; }
Â  .brand-text { display: flex; flex-direction: column; min-width: 0; }
Â  nav { display:flex; gap:8px; align-items:center; flex-shrink: 0; }
Â  .logo {
Â  Â  width:40px; height:40px; border-radius:10px; background:var(--primary); display:flex;
Â  Â  align-items:center; justify-content:center; color:white; font-weight:700; flex-shrink: 0;
Â  }
Â  .title { font-weight:600; font-size:1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
Â  .header-avatar {
Â  Â  width: 40px; height: 40px; border-radius: 10px; object-fit: cover;
Â  Â  flex-shrink: 0; background: #e0f2fe; color: var(--primary-dark);
Â  Â  display: flex; align-items: center; justify-content: center; font-weight: bold;
Â  }
Â  nav button { background:transparent; border:none; padding:8px 10px; border-radius:8px; cursor:pointer; color:var(--muted); font-weight: 500;}
Â  nav button.active { background:var(--primary-light); color:var(--primary-dark); }
Â  .container { max-width:1100px; margin:18px auto; padding:0 14px; }
Â  .page { display:none; margin-top:14px; }
Â  .card { background:var(--card); border-radius:var(--radius); box-shadow: var(--shadow); padding:16px; margin-bottom:16px; }
Â  h2 { font-size: 1.75rem; font-weight: 700; color: var(--text); margin: 0 0 8px 0; }
Â  p { color:var(--muted); line-height:1.5; margin: 4px 0; }
Â  .muted { color:var(--muted); font-size:0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
Â  input,textarea,select,button { font-size:1rem; font-family: inherit; }
Â  input,select,textarea { width:100%; box-sizing:border-box; padding:10px 12px; border-radius:8px; border:1px solid #cbd5e1; background:var(--bg); color:var(--text); }
Â  input:disabled { background: #e2e8f0; cursor: not-allowed; }
Â  .btn { background:var(--primary); color:white; border:none; padding:10px 16px; border-radius:8px; cursor:pointer; font-weight: 600; }
Â  .btn.secondary { background:var(--primary-light); color:var(--primary-dark); }
Â  .btn:disabled { background: #94a3b8; cursor: not-allowed; }
Â  .avatar-preview { width:72px; height:72px; border-radius:50%; object-fit:cover; background: var(--primary-light); color: var(--primary-dark);
Â  Â  display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 2rem;}
Â  .footer { text-align:center; font-size:0.8rem; color:var(--muted); padding:16px 0; background: transparent; box-shadow: none;}
Â  #toast {
Â  Â  position:fixed; bottom: 100px; left:50%; transform:translateX(-50%);
Â  Â  background: #0f172a; color:white; padding:12px 20px; border-radius:8px;
Â  Â  z-index: 3000; visibility:hidden; opacity:0; transition: all 0.4s ease; text-align: center;
Â  Â  box-shadow: 0 8px 20px rgba(0,0,0,0.2);
Â  }
Â  #toast.show { visibility:visible; opacity:1; }
Â  #toast.error { background-color: var(--danger); }
Â  .warning-box { background-color: #fffbeb; color: #b45309; border: 1px solid #fde68a; border-radius: 8px; padding: 12px; margin: 16px 0; }
Â  .info-box { background-color: #eff6ff; color: #1e40af; border: 1px solid #bfdbfe; border-radius: 8px; padding: 12px; margin: 16px 0; }
Â  .feature-disabled { opacity: 0.6; cursor: not-allowed; }
Â  .feature-disabled label { display: flex; justify-content: space-between; align-items: center; }
Â  .coming-soon-tag { font-size: 0.75rem; background: var(--warning); color: white; padding: 2px 6px; border-radius: 4px; font-weight: 600;}

Â  @media (max-width: 420px) {
Â  Â  .title { display: none; }
Â  }
</style>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>

<header>
Â  <div class="brand">
Â  Â  <div id="headerLogo" class="logo">QS</div>
Â  Â  <div id="headerPfp" class="header-avatar hidden"></div>
Â  Â  <div class="brand-text">
Â  Â  Â  Â  <div class="title">Q Solve</div>
Â  Â  Â  Â  <div class="muted" id="greetingSmall">Welcome</div>
Â  Â  </div>
Â  </div>
Â  <nav id="mainNav">
Â  Â  <button class="nav-btn" data-action="navigate" data-page="homePage">Home</button>
Â  Â  <button class="nav-btn" data-action="navigate" data-page="solvePage">Solve</button>
Â  Â  <button class="nav-btn" data-action="navigate" data-page="historyPage">History</button>
Â  Â  <button class="nav-btn" data-action="navigate" data-page="settingsPage">Settings</button>
Â  </nav>
</header>

<div class="container">
Â  <div id="welcomeScreen" class="page card"></div> <div id="homePage" class="page"></div> <div id="solvePage" class="page"></div>
Â  <div id="historyPage" class="page"></div> <div id="settingsPage" class="page"></div>
Â  <div class="footer">
Â  Â  Â  <div>Made by Kabir Gagneja Â© 2025</div>
Â  Â  Â  <div>@Kabir Gagneja Invents</div>
Â  </div>
</div>

<div id="toast"></div>

<template id="welcomeScreenTemplate">
Â  <h2>Welcome to Q Solve</h2> <p>Your personal homework helper, redesigned.</p>
Â  <div style="margin-top:20px;"> <label>Please enter your name to begin:</label> <input id="setupName" placeholder="e.g., Kabir" style="margin-top: 4px;"/> </div>
Â  <div class="info-box"> <p><strong>Note:</strong> This app uses cookies to save your settings. By continuing, you agree to their use.</p> </div>
Â  <button class="btn" data-action="accept-welcome" style="margin-top:15px; width:100%; padding: 12px;">Get Started</button>
</template>
<template id="homePageTemplate">
Â  <div class="card"> <h2>Hello, <span id="userNameDisplay">Student</span> ðŸ‘‹</h2> <p>Ready to solve some problems?</p>
Â  Â  <div style="display:flex; gap:8px; margin-top:16px;">
Â  Â  Â  <button class="btn" data-action="navigate" data-page="solvePage">Solve a New Question</button>
Â  Â  Â  <button class="btn secondary" data-action="navigate" data-page="historyPage">View History</button>
Â  Â  </div>
Â  </div>
Â  <div class="card"> <h3>Most Recent Conversation</h3> <div id="recentList"></div> </div>
</template>
<template id="solvePageTemplate">
Â  <div class="card"> <h2>Solve a Question</h2> <p>Paste text directly to get an AI-powered answer.</p>
Â  Â  <div class="info-box"> <p>AI features require a working internet connection to contact Google's servers.</p> </div>
Â  Â  <div class="feature-disabled" style="margin-top:15px;">
Â  Â  Â  Â  <label for="ocrFile">Upload Image (OCR) <span class="coming-soon-tag">Coming Soon</span></label>
Â  Â  Â  Â  <input type="file" id="ocrFile" disabled style="margin-top: 4px;">
Â  Â  </div>
Â  Â  <div style="margin-top: 15px;">
Â  Â  Â  Â  <label for="pasteText">Or paste your question here:</label>
Â  Â  Â  Â  <textarea id="pasteText" rows="4" placeholder="e.g., What is the powerhouse of the cell?" style="margin-top: 4px;"></textarea>
Â  Â  </div>
Â  Â  <button class="btn" data-action="run-ocr" style="margin-top:12px;">Extract & Solve</button>
Â  Â  <div id="detectedQuestions" style="margin-top:16px;"></div>
Â  </div>
</template>
<template id="historyPageTemplate">
Â  <div class="card"> <h2>Conversation History</h2>
Â  Â  Â  <div class="warning-box"><p><b>Storage Notice:</b> History is limited to the single most recent conversation because of device constraints.</p></div>
Â  Â  Â  <div id="historyList" style="margin-top:16px;"></div>
Â  </div>
</template>
<template id="settingsPageTemplate">
Â  <div class="row">
Â  Â  <div class="col card"> <h2>Profile Settings</h2>
Â  Â  Â  <div style="display:flex; gap:16px; align-items:center; margin-top: 12px;">
Â  Â  Â  Â  <div id="avatarPreview" class="avatar-preview">K</div>
Â  Â  Â  Â  <div style="flex:1;">
Â  Â  Â  Â  Â  Â  <label for="userName">Your Name</label>
Â  Â  Â  Â  Â  Â  <input type="text" id="userName" placeholder="Your name" style="margin-top:4px;">
Â  Â  Â  Â  Â  Â  <div class="feature-disabled" style="margin-top: 12px;">
Â  Â  Â  Â  Â  Â  Â  Â  <label>Profile Picture <span class="coming-soon-tag">Coming Soon</span></label>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>
Â  <div class="row">
Â  Â  <div class="col card"> <h2>Preferences</h2>
Â  Â  Â  Â  <label for="themeSelect">Theme</label>
Â  Â  Â  Â  <select id="themeSelect" style="margin-top:4px;"> <option value="default">Light (Default)</option> <option value="dark">Dark</option> </select>
Â  Â  </div>
Â  </div>
Â  <div class="card" style="text-align:center; margin-top: 16px;">
Â  Â  <button class="btn" data-action="save-settings">Save All Settings</button>
Â  Â  <button class="btn" data-action="reset-app" style="background:var(--danger); margin-left: 8px;">Reset App</button>
Â  </div>
</template>

<!-- MAIN APP SCRIPT -->
<script>
(function() {
'use strict';
window.onerror = function(message, source, lineno) {
Â  Â  alert('Critical Error at line ' + lineno + ': ' + message);
Â  Â  return true;
};

var DEFAULT_API_KEY = 'AIzaSyDFkqehdCYrwxkwR8TSicSLHZrMnAJ3XXY';
var App = {
Â  pages: ['welcomeScreen', 'homePage', 'solvePage', 'historyPage', 'settingsPage'],
Â  dataKey: 'qsolve_data_v17', userKey: 'qsolve_user_v17', history: [],
Â  settings: { name: 'Student', theme: 'default' },
};

function setCookie(name, value, days) {
Â  Â  var expires = "";
Â  Â  if (days) {
Â  Â  Â  Â  var date = new Date();
Â  Â  Â  Â  date.setTime(date.getTime() + (days*24*60*60*1000));
Â  Â  Â  Â  expires = "; expires=" + date.toUTCString();
Â  Â  }
Â  Â  try {
Â  Â  Â  Â document.cookie = name + "=" + (encodeURIComponent(JSON.stringify(value)) || "")Â  + expires + "; path=/; SameSite=Lax";
Â  Â  } catch (e) { console.error("Cookie setting failed"); }
}

function getCookie(name) {
Â  Â  var nameEQ = name + "=";
Â  Â  var ca = document.cookie.split(';');
Â  Â  for(var i=0;i < ca.length;i++) {
Â  Â  Â  Â  var c = ca[i];
Â  Â  Â  Â  while (c.charAt(0)==' ') c = c.substring(1,c.length);
Â  Â  Â  Â  if (c.indexOf(nameEQ) == 0) {
Â  Â  Â  Â  Â  Â try {
Â  Â  Â  Â  Â  Â  Â  return JSON.parse(decodeURIComponent(c.substring(nameEQ.length,c.length)));
Â  Â  Â  Â  Â  Â } catch(e) { return null; }
Â  Â  Â  Â  }
Â  Â  }
Â  Â  return null;
}

function eraseCookie(name) {Â  Â 
Â  Â  document.cookie = name+'=; Max-Age=-99999999; path=/;';
}

function saveData() {
Â  Â  var historyToSave = App.history.length > 0 ? [App.history[0]] : [];
Â  Â  setCookie(App.dataKey, historyToSave, 365);
Â  Â  setCookie(App.userKey, App.settings, 365);
}

function loadData() {
Â  var loadedHistory = getCookie(App.dataKey);
Â  var loadedSettings = getCookie(App.userKey);
Â  try {
Â  Â  if (loadedHistory) App.history = loadedHistory;
Â  Â  if (loadedSettings) {
Â  Â  Â  Â  var defaultSettings = { name: 'Student', theme: 'default' };
Â  Â  Â  Â  for (var key in loadedSettings) {
Â  Â  Â  Â  Â  Â  if (Object.prototype.hasOwnProperty.call(loadedSettings, key)) {
Â  Â  Â  Â  Â  Â  Â  Â  defaultSettings[key] = loadedSettings[key];
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  App.settings = defaultSettings;
Â  Â  }
Â  } catch (e) {
Â  Â  showToast("Error loading saved data.", "error"); App.history = [];
Â  }
}

function clearData() {
Â  Â  eraseCookie(App.dataKey); eraseCookie(App.userKey);
Â  Â  eraseCookie('qsolve_first_time_' + App.dataKey.split('_')[2]);
}

function showPage(id) {
Â  for(var i=0; i < App.pages.length; i++) {
Â  Â  var el = document.getElementById(App.pages[i]);
Â  Â  if (el) el.style.display = 'none';
Â  }
Â  var page = document.getElementById(id);
Â  if (!page) return;
Â  var template = document.getElementById(id + "Template");
Â  if (template) page.innerHTML = template.innerHTML;
Â  page.style.display = 'block';
Â  var header = document.querySelector('header');
Â  if (header) {
Â  Â  Â  header.style.display = (id === 'welcomeScreen') ? 'none' : 'flex';
Â  }
Â  var navBtns = document.querySelectorAll('.nav-btn');
Â  for(var j=0; j < navBtns.length; j++) {
Â  Â  navBtns[j].classList.remove('active');
Â  }
Â  var activeBtn = document.querySelector('.nav-btn[data-page="' + id + '"]');
Â  if (activeBtn) activeBtn.classList.add('active');
Â  if (id !== 'welcomeScreen') updateHeaderUI();
Â  if (id === 'settingsPage') updateSettingsPageUI();
Â  if (id === 'historyPage') refreshHistoryList();
Â  if (id === 'homePage') refreshHomePage();
}

function applyTheme() {
Â  document.body.className = App.settings.theme === 'dark' ? 'dark' : '';
}

function showToast(message, type) {
Â  var toast = document.getElementById('toast');
Â  if (!toast) { alert(message); return; }
Â  toast.textContent = message;
Â  toast.className = 'show';
Â  if (type === 'error') toast.classList.add('error');
Â  setTimeout(function() { toast.className = toast.className.replace('show', ''); }, 5000);
}

function escapeHtml(s) {
Â  if (s === null || s === undefined) return '';
Â  var el = document.createElement('div');
Â  el.textContent = s;
Â  return el.innerHTML;
}

function formatAIResponse(text) {
Â  return escapeHtml(text).replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/\n/g, '<br>');
}

function cleanHistory(history) {
Â  Â  var sanitizedHistory = [];
Â  Â  if (Object.prototype.toString.call(history) !== '[object Array]') {
Â  Â  Â  Â  return [];
Â  Â  }
Â  Â  for (var i = 0; i < history.length; i++) {
Â  Â  Â  Â  var turn = history[i];
Â  Â  Â  Â  if (turn && turn.role && turn.parts && typeof turn.parts.length !== 'undefined') {
Â  Â  Â  Â  Â  Â  sanitizedHistory.push(turn);
Â  Â  Â  Â  }
Â  Â  }
Â  Â  return sanitizedHistory;
}

// --- NEW: Direct API call using fetch ---
function getAIResponse(prompt, history) {
Â  return new Promise(function(resolve) {
Â  Â  var apiUrl = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=" + DEFAULT_API_KEY;
Â  Â Â 
Â  Â  var sanitizedHistory = cleanHistory(history);
Â  Â  var requestBody = {
Â  Â  Â  contents: sanitizedHistory.concat([
Â  Â  Â  Â  {
Â  Â  Â  Â  Â  "parts": [
Â  Â  Â  Â  Â  Â  { "text": prompt }
Â  Â  Â  Â  Â  ]
Â  Â  Â  Â  }
Â  Â  Â  ])
Â  Â  };

Â  Â  fetch(apiUrl, {
Â  Â  Â  method: 'POST',
Â  Â  Â  headers: {
Â  Â  Â  Â  'Content-Type': 'application/json'
Â  Â  Â  },
Â  Â  Â  body: JSON.stringify(requestBody)
Â  Â  })
Â  Â  .then(function(response) {
Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  // Try to get more detailed error from the API response body
Â  Â  Â  Â  return response.json().then(function(errorBody) {
Â  Â  Â  Â  Â  var message = (errorBody.error && errorBody.error.message) ? errorBody.error.message : 'HTTP error! status: ' + response.status;
Â  Â  Â  Â  Â  throw new Error(message);
Â  Â  Â  Â  }).catch(function() {
Â  Â  Â  Â  Â  throw new Error('HTTP error! status: ' + response.status);
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  Â  return response.json();
Â  Â  })
Â  Â  .then(function(data) {
Â  Â  Â  if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0]) {
Â  Â  Â  Â  resolve(data.candidates[0].content.parts[0].text);
Â  Â  Â  } else {
Â  Â  Â  Â  // Handle cases where the response is successful but empty, e.g., safety block
Â  Â  Â  Â  if(data.promptFeedback && data.promptFeedback.blockReason){
Â  Â  Â  Â  Â  Â  Â resolve("Response blocked due to: " + data.promptFeedback.blockReason);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â resolve("AI returned an empty response.");
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  })
Â  Â  .catch(function(error) {
Â  Â  Â  showToast('AI Error: ' + error.message, 'error');
Â  Â  Â  resolve('AI Error: Could not get a response.');
Â  Â  });
Â  });
}

function updateHeaderUI() {
Â  var name = App.settings.name || 'User';
Â  var greeting = document.getElementById('greetingSmall');
Â  if(greeting) greeting.innerText = 'Hi, ' + name;
Â  var headerPfp = document.getElementById('headerPfp');
Â  var headerLogo = document.getElementById('headerLogo');
Â  if(headerPfp && headerLogo){
Â  Â  Â  headerPfp.textContent = name.charAt(0).toUpperCase();
Â  Â  Â  headerLogo.classList.add('hidden');
Â  Â  Â  headerPfp.classList.remove('hidden');
Â  }
}

function updateSettingsPageUI() {
Â  document.getElementById('userName').value = App.settings.name || '';
Â  var name = App.settings.name || 'U';
Â  document.getElementById('avatarPreview').textContent = name.charAt(0).toUpperCase();
Â  document.getElementById('themeSelect').value = App.settings.theme;
}

function refreshHomePage() {
Â  var userNameDisplay = document.getElementById('userNameDisplay');
Â  if (userNameDisplay) userNameDisplay.textContent = App.settings.name || 'Student';
Â  var recentList = document.getElementById('recentList');
Â  if (recentList) {
Â  Â  recentList.innerHTML = '';
Â  Â  if (App.history.length === 0) {
Â  Â  Â  recentList.innerHTML = '<p class="muted">Your most recent conversation will appear here.</p>'; return;
Â  Â  }
Â  Â  var item = App.history[0];
Â  Â  var title = escapeHtml(item.title.slice(0, 80));
Â  Â  recentList.innerHTML += '<div class="card">' + title + '...</div>';
Â  }
}

function renderDetectedQuestions(questions) {
Â  var container = document.getElementById('detectedQuestions');
Â  if (!container) return;
Â  container.innerHTML = '';
Â  var html = '';
Â  for(var i=0; i<questions.length; i++) {
Â  Â  var questionHtml = escapeHtml(questions[i]);
Â  Â  html += '<div class="card" data-conversation-history="[]"><p><strong>Q:</strong> ' + questionHtml + '</p><div class="ai-answer-container" style="display: none; margin-top: 12px;"></div><div style="margin-top:12px;"><button class="btn" data-action="start-conversation">Solve with AI</button></div><div class="conversation-controls" style="display:none; margin-top:10px;"><textarea class="follow-up-input" rows="2" placeholder="Ask a follow-up..."></textarea><button class="btn" data-action="ask-follow-up" style="margin-top:5px;">Send</button></div></div>';
Â  }
Â  container.innerHTML += html;
}

function refreshHistoryList() {
Â  Â  var historyList = document.getElementById('historyList');
Â  Â  if (!historyList) return;
Â  Â  if (App.history.length === 0) {
Â  Â  Â  Â  historyList.innerHTML = '<p class="muted">No conversations found.</p>'; return;
Â  Â  }
Â  Â  var html = '';
Â  Â  var item = App.history[0];
Â  Â  var conversationHtml = item.conversation.map(function(turn) {
Â  Â  Â  Â  return '<div class="chat-bubble ' + (turn.role === 'user' ? 'user' : 'model') + '">' + formatAIResponse(turn.parts[0].text) + '</div>';
Â  Â  }).join('');
Â  Â  html += '<div><h4>' + escapeHtml(item.title) + '</h4>' + conversationHtml + '</div>';
Â  Â  historyList.innerHTML = html;
}

function findClosest(elem, selector) {
Â  Â  var current = elem;
Â  Â  while (current && current !== document.body) {
Â  Â  Â  Â  if (typeof current.matches === 'function' && current.matches(selector)) { return current; }
Â  Â  Â  Â  current = current.parentNode;
Â  Â  }
Â  Â  return null;
}

function init() {
Â  loadData();
Â  applyTheme();
Â  var firstTime = getCookie('qsolve_first_time_' + App.dataKey.split('_')[2]) !== 'true';
Â  showPage(firstTime ? 'welcomeScreen' : 'homePage');
}

document.addEventListener('DOMContentLoaded', function() {
Â  init();
Â  document.body.addEventListener('click', function(e) {
Â  Â  var target = e.target;
Â  Â  while (target && target !== document.body) {
Â  Â  Â  Â  if (target.getAttribute('data-action')) break;
Â  Â  Â  Â  target = target.parentNode;
Â  Â  }
Â  Â  if (!target || !target.getAttribute('data-action')) return;
Â  Â Â 
Â  Â  var action = target.getAttribute('data-action');
Â  Â  var card = findClosest(target, '.card');
Â  Â Â 
Â  Â  if (action === 'navigate') {
Â  Â  Â  Â  showPage(target.getAttribute('data-page'));
Â  Â  } else if (action === 'accept-welcome') {
Â  Â  Â  App.settings.name = document.getElementById('setupName').value.trim() || 'Student';
Â  Â  Â  saveData();
Â  Â  Â  setCookie('qsolve_first_time_' + App.dataKey.split('_')[2], 'true', 365);
Â  Â  Â  showPage('homePage');
Â  Â  } else if (action === 'run-ocr') {
Â  Â  Â  var text = document.getElementById('pasteText').value.trim();
Â  Â  Â  if (text) renderDetectedQuestions(text.split(/\n\s*\n+/));
Â  Â  Â  else showToast('Please paste a question first.', 'error');
Â  Â  } else if (action === 'start-conversation' || action === 'ask-follow-up') {
Â  Â  Â  Â  if (!card) return;
Â  Â  Â  Â  var answerContainer = card.querySelector('.ai-answer-container');
Â  Â  Â  Â  var questionTextElem = card.querySelector('p');
Â  Â  Â  Â  var followUpInput = card.querySelector('.follow-up-input');
Â  Â  Â  Â  var prompt;
Â  Â  Â  Â  var existingHistory = JSON.parse(card.getAttribute('data-conversation-history') || '[]');
Â  Â  Â  Â  if (action === 'start-conversation') {
Â  Â  Â  Â  Â  Â  prompt = questionTextElem.textContent.replace('Q: ','');
Â  Â  Â  Â  Â  Â  answerContainer.innerHTML = '<div class="chat-bubble user">' + formatAIResponse(prompt) + '</div>';
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  prompt = followUpInput.value.trim();
Â  Â  Â  Â  Â  Â  if (!prompt) return;
Â  Â  Â  Â  Â  Â  answerContainer.innerHTML += '<div class="chat-bubble user">' + formatAIResponse(prompt) + '</div>';
Â  Â  Â  Â  Â  Â  followUpInput.value = '';
Â  Â  Â  Â  }
Â  Â  Â  Â  answerContainer.style.display = 'block'; target.textContent = 'Thinking...'; target.disabled = true;
Â  Â  Â  Â  getAIResponse(prompt, existingHistory).then(function(aiResponse) {
Â  Â  Â  Â  Â  Â  existingHistory.push({ role: 'user', parts: [{ text: prompt }] });
Â  Â  Â  Â  Â  Â  existingHistory.push({ role: 'model', parts: [{ text: aiResponse }] });
Â  Â  Â  Â  Â  Â  card.setAttribute('data-conversation-history', JSON.stringify(existingHistory));
Â  Â  Â  Â  Â  Â  answerContainer.innerHTML += '<div class="chat-bubble model">' + formatAIResponse(aiResponse) + '</div>';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  App.history[0] = { id: 'q-' + Date.now(), title: prompt.slice(0, 100), conversation: existingHistory };
Â  Â  Â  Â  Â  Â  saveData();

Â  Â  Â  Â  Â  Â  if (action === 'start-conversation') {
Â  Â  Â  Â  Â  Â  Â  Â  target.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  card.querySelector('.conversation-controls').style.display = 'block';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  target.textContent = action === 'start-conversation' ? 'Solve with AI' : 'Send';
Â  Â  Â  Â  Â  Â  target.disabled = false;
Â  Â  Â  Â  });
Â  Â  } else if (action === 'save-settings') {
Â  Â  Â  Â  App.settings.name = document.getElementById('userName').value.trim();
Â  Â  Â  Â  App.settings.theme = document.getElementById('themeSelect').value;
Â  Â  Â  Â  saveData(); applyTheme(); updateHeaderUI(); showToast("Settings saved!");
Â  Â  } else if (action === 'reset-app') {
Â  Â  Â  Â  if (confirm("This will erase all your settings. Are you sure?")) {
Â  Â  Â  Â  Â  Â  clearData();
Â  Â  Â  Â  Â  Â  App.history = [];
Â  Â  Â  Â  Â  Â  App.settings = { name: 'Student', theme:'default' };
Â  Â  Â  Â  Â  Â  applyTheme(); showPage('welcomeScreen');
Â  Â  Â  Â  Â  Â  showToast('App has been reset.');
Â  Â  Â  Â  }
Â  Â  }
Â  });
});
})();
</script>

</body>
</html>